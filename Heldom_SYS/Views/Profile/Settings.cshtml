@* stylesheet *@
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

@* https://localhost:7142/Profile/Settings *@

<div id="loading" style="display: none;">Loading...</div>
<div class="main_wrap border-radius box-shadow" id="profileContainer">
    <div class="setting_main_area obj-horizontal-center">
        <div class="top_area txt-left">
            <h4 class="bold">個人資料設定</h4>
        </div>
        <div class="middle_area">
            <div class="setting-row">
                <div class="input_wrap">
                    <p class="color-gray-dark bold">員工姓名</p>
                    <input type="text" id="employeeName" class="form-control" value="姓名" disabled />
                </div>
                <div class="input_wrap">
                    <p class="color-gray-dark bold">職位</p>
                    <input type="text" id="position" class="form-control" value="技士" disabled />
                </div>
            </div>
            <div class="setting-row">
                <div class="input_wrap">
                    <p class="color-gray-dark bold">員工編號</p>
                    <input type="text" id="employeeId" class="form-control" value="" disabled />
                </div>
                <div class="input_wrap">
                    <p class="color-gray-dark bold">生日</p>
                    <input type="date" id="birthDate" class="form-control" value="2025-02-20" disabled />
                </div>
            </div>
            <div class="setting-row">
                <div class="input_wrap">
                    <p class="color-gray-dark bold">聯絡電話</p>
                    <input type="tel" id="phoneNumber" class="form-control" value="0919-123456" />
                </div>
                <div class="input_wrap">
                    <p class="color-gray-dark bold">地址</p>
                    <input type="text" id="address" class="form-control" value="台中市台中市台中市台中市台中市" />
                </div>
            </div>
            <div class="setting-row">
                <div class="input_wrap">
                    <p class="color-gray-dark bold">緊急聯絡人</p>
                    <input type="text" id="emergencyContact" class="form-control" value="聯絡人" />
                </div>
                <div class="input_wrap">
                    <p class="color-gray-dark bold">緊急電話</p>
                    <input type="tel" id="emergencyPhone" class="form-control" value="0919-123456" />
                </div>
            </div>
        </div>
        <div class="button_area">
            <button type="button" class="btn btn-outline" id="cancel"><p class="color-blue">取消</p></button>
            <button type="button" class="btn btn-primary" id="save"><p>儲存</p></button>
        </div>
    </div>
</div>

<script>
    // Show loading indicator
    $("#loading").show();

    $(document).ready(function(){

        axios.get('/Profile/GetSettingsData')
        .then(function(response){

            console.log(response);
            console.log(response.data[0].name);
            appendProfileInfo(response.data[0]);
        })
        .catch(function(error){
            console.error("GetSettingsData failed!",error);
        })
        .finally(function() {
            // Hide loading indicator and show profile content
            $("#loading").hide();
            $("#profileContainer").show();
        });
    });

    function appendProfileInfo(data){
        console.log("Appending profile info:",data.employeeID); // Debugging line

        document.getElementById("employeeName").value = data.name;
        document.getElementById("position").value = data.position;
        document.getElementById("employeeId").value = data.employeeID;
        document.getElementById("birthDate").value = formatDate(data.birthDate);
        document.getElementById("phoneNumber").value = data.phoneNumber;
        document.getElementById("address").value = data.address;
        document.getElementById("emergencyContact").value = data.emergencyContact;
        document.getElementById("emergencyPhone").value = data.emergencyContactPhone;
    }

    // 轉換日期格式
    function formatDate(dateString) {
        if (!dateString) return '';
        let date = new Date(dateString);
        let year = date.getFullYear();
        // getDate() 取 0-11而已, 要自己 +1
        let month = String(date.getMonth() + 1).padStart(2, '0');
        let day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    $('#cancel').click(function(){
        location.href ="https://" + location.hostname + ":" +window.location.port + "/Profile/Index";
    });

    $('#save').click(function(){

        let phoneNumber = document.getElementById("phoneNumber").value;
        let address = document.getElementById("address").value;
        let emergencyContact = document.getElementById("emergencyContact").value;
        let emergencyContactPhone = document.getElementById("emergencyPhone").value;

        // 準備要發送的資料
        let updateData = {
            phoneNumber: phoneNumber,
            address: address,
            emergencyContact: emergencyContact,
            emergencyContactPhone: emergencyContactPhone
        };

        // 發送 POST 請求到後端
        axios.post('/Profile/UpdateEmployeeInfo', updateData)
            .then(function(response) {
                if (response.data.success) {
                    alert('資料更新成功！');
                    // 更新成功後返回上一頁
                    window.location.href = '/Profile/Index';
                } else {
                    alert('更新失敗：' + response.data.message);
                }
            })
            .catch(function(error) {
                console.error('更新失敗：', error);
                alert('更新失敗，請稍後再試！');
            });
    });

</script>

<style>
    .main_wrap {
        width: 100%;
        height: auto;
        padding: 60px 40px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .setting_main_area {
        max-width: 1000px;
        width: 100%;
        display: flex;
        flex-direction: column;
        row-gap: 40px;
    }

    .top_area {
        width: 100%;
        display: flex;
    }

    .middle_area {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .setting-row {
        display: flex;
        flex-direction: row;
        gap: 40px;
    }

    .input_wrap {
        flex: 1;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
    }

        .input_wrap p {
            margin: 0;
            width: 100px;
        }

    .form-control {
        width: 360px !important;
        height: 48px !important;
        padding: 4px 12px;
        border: 1px solid var(--color-line);
        border-radius: 10px !important;
    }

    .button_area {
        display: flex;
        justify-content: center;
        gap: 40px;
    }

        .button_area button {
            width: 240px !important;
            height: 54px !important;
            border-radius: 28px;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

            .button_area button p {
                margin: 0;
                font-weight: bold;
            }

    /* 修改取消按鈕樣式 */
    .btn-outline {
        background-color: rgba(0, 64, 221, 0.2);
        !important; /* 使用 20% 透明度 */
        border: 1px solid var(--color-blue) !important;
    }

        .btn-outline p {
            color: var(--color-blue) !important;
        }

    /* 保持儲存按鈕樣式 */
    .btn-primary {
        background-color: var(--color-blue);
    }

        .btn-primary p {
            color: white;
        }

    /* 新增：設定 disabled 狀態的 input 樣式 */
    .form-control:disabled {
        background-color: var(--color-gray-light-opacity) !important;
        opacity: 1 !important; /* 確保文字清晰可見 */
        cursor: not-allowed;
    }
</style>